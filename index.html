<!DOCTYPE html>
<html>
<head>
  <title>Machine Telemetry Table</title>
  <style>
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background-color: #f0f0f0; }
    .bell { color: red; cursor: pointer; margin-left: 5px; }
    #error-box { color: red; margin-top: 10px; text-align: center; }
  </style>
</head>
<body>
  <h2>Machine Telemetry Table</h2>
  <table>
    <thead>
      <tr id="header-row">
        <th>Attribute</th>
        <th id="header-M1">Machine 1</th>
        <th id="header-M2">Machine 2</th>
        <th id="header-M3">Machine 3</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>A1</td><td id="M1_A1">--</td><td id="M2_A1">--</td><td id="M3_A1">--</td></tr>
      <tr><td>A2</td><td id="M1_A2">--</td><td id="M2_A2">--</td><td id="M3_A2">--</td></tr>
      <tr><td>A3</td><td id="M1_A3">--</td><td id="M2_A3">--</td><td id="M3_A3">--</td></tr>
    </tbody>
  </table>

  <div id="error-box"></div>

  <script>
    window.onload = function () {
      const params = new URLSearchParams(window.location.search);
      const jwt = params.get("token");

      const deviceId = "1e101ee0-5bd5-11f0-9d02-c191323b4da2";
      const baseUrl = "https://thingsboard.cloud";

      const machines = {
        "M1": ["M1_A1", "M1_A2", "M1_A3"],
        "M2": ["M2_A1", "M2_A2", "M2_A3"],
        "M3": ["M3_A1", "M3_A2", "M3_A3"]
      };

      const alarms = {
        "M1": "M1_Alarm",
        "M2": "M2_Alarm",
        "M3": "M3_Alarm"
      };

      const bellAcknowledged = { M1: false, M2: false, M3: false };
      const alarmCounts = { M1: 0, M2: 0, M3: 0 };
      const errorBox = document.getElementById("error-box");

      function reorderColumns(order, alarmValues) {
        const headerRow = document.getElementById("header-row");
        const newHeader = document.createElement("tr");
        newHeader.id = "header-row";
        newHeader.appendChild(Object.assign(document.createElement("th"), { innerText: "Attribute" }));

        order.forEach(machine => {
          const th = document.createElement("th");
          th.id = `header-${machine}`;

          const count = alarmCounts[machine] || 0;
          th.innerText = `Machine ${machine[1]} (Alarms = ${count})`;

          if (alarmValues[machine] && !bellAcknowledged[machine]) {
            const bell = document.createElement("span");
            bell.className = "bell";
            bell.innerText = "üîî";
            bell.title = "Click to acknowledge";
            bell.onclick = e => {
              e.stopPropagation();
              bellAcknowledged[machine] = true;
              fetchTelemetry();
            };
            th.appendChild(bell);
          }

          newHeader.appendChild(th);
        });

        headerRow.replaceWith(newHeader);

        document.querySelectorAll("tbody tr").forEach((row, i) => {
          const newRow = document.createElement("tr");
          newRow.appendChild(row.children[0].cloneNode(true));
          order.forEach(m => {
            const id = machines[m][i];
            const old = document.getElementById(id);
            const cell = document.createElement("td");
            cell.id = id;
            cell.innerText = old?.innerText || "--";
            newRow.appendChild(cell);
          });
          row.replaceWith(newRow);
        });
      }

      async function fetchAlarmCounts() {
        const now = Date.now();
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);
        const startTs = todayStart.getTime();
        const endTs = now;

        for (const [mKey, alarmKey] of Object.entries(alarms)) {
          const url = `${baseUrl}/api/plugins/telemetry/DEVICE/${deviceId}/values/timeseries?keys=${alarmKey}&startTs=${startTs}&endTs=${endTs}&interval=1000&limit=1000&agg=NONE`;

          try {
            const res = await fetch(url, {
              headers: { "X-Authorization": `Bearer ${jwt}` }
            });

            const data = await res.json();
            const values = data[alarmKey] || [];

            // Count only where alarm value = 1
            const count = values.filter(item => parseInt(item.value) === 1).length;
            alarmCounts[mKey] = count;
          } catch (err) {
            console.warn(`Failed to fetch alarm history for ${alarmKey}`);
            alarmCounts[mKey] = 0;
          }
        }
      }

      async function fetchTelemetry() {
        try {
          errorBox.innerText = "";

          await fetchAlarmCounts(); // fetch alarm history

          const keys = [...Object.values(machines).flat(), ...Object.values(alarms)];
          const res = await fetch(`${baseUrl}/api/plugins/telemetry/DEVICE/${deviceId}/values/timeseries?keys=${keys.join(",")}`, {
            headers: { "X-Authorization": `Bearer ${jwt}` }
          });

          const data = await res.json();

          const alarmEntries = [];
          const inactive = [];

          for (const m of ["M1", "M2", "M3"]) {
            const alarmKey = alarms[m];
            const alarmVal = parseInt(data[alarmKey]?.[0]?.value || 0);
            const ts = data[alarmKey]?.[0]?.ts || 0;

            if (alarmVal === 1) {
              alarmEntries.push({ machine: m, ts });
            } else {
              bellAcknowledged[m] = false;
              inactive.push(m);
            }

            machines[m].forEach(k => {
              const el = document.getElementById(k);
              if (data[k]?.[0] && el) {
                el.innerText = parseFloat(data[k][0].value);
              } else if (el) {
                el.innerText = "--";
              }
            });
          }

          alarmEntries.sort((a, b) => b.ts - a.ts);
          const order = [...alarmEntries.map(a => a.machine), ...inactive];
          const activeMap = Object.fromEntries(alarmEntries.map(a => [a.machine, 1]));

          reorderColumns(order, activeMap);
        } catch (err) {
          console.error("Telemetry fetch error:", err);
          errorBox.innerText = "‚ö†Ô∏è Error fetching telemetry data";
        }
      }

      fetchTelemetry();
      setInterval(fetchTelemetry, 10000);
    };
  </script>
</body>
</html>
