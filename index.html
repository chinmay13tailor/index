<!DOCTYPE html>
<html>
<head><title>Machine Telemetry Table</title>
  <style>
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ddd; padding:10px; text-align:center; }
    th { background:#f0f0f0; }
    .bell { color:red; cursor:pointer; margin-left:5px; }
  </style>
</head>
<body>
  <h2>Machine Telemetry Table</h2>
  <table>
    <thead><tr id="header-row">
      <th>Attribute</th>
      <th id="header-M1">Machine 1</th>
      <th id="header-M2">Machine 2</th>
      <th id="header-M3">Machine 3</th>
    </tr></thead>
    <tbody>
      <tr><td>A1</td><td id="M1_A1">--</td><td id="M2_A1">--</td><td id="M3_A1">--</td></tr>
      <tr><td>A2</td><td id="M1_A2">--</td><td id="M2_A2">--</td><td id="M3_A2">--</td></tr>
      <tr><td>A3</td><td id="M1_A3">--</td><td id="M2_A3">--</td><td id="M3_A3">--</td></tr>
    </tbody>
  </table>

  <script>
    window.onload = function() {
      const params = new URLSearchParams(window.location.search);
      const jwt = params.get("token");
      const deviceId = "1e101ee0-5bd5-11f0-9d02-c191323b4da2";
      const baseUrl = "https://thingsboard.cloud";
      const machines = {
        "M1":["M1_A1","M1_A2","M1_A3"],
        "M2":["M2_A1","M2_A2","M2_A3"],
        "M3":["M3_A1","M3_A2","M3_A3"]
      };

      const alertState = {
        "M1":{ active:false, acknowledged:false },
        "M2":{ active:false, acknowledged:false },
        "M3":{ active:false, acknowledged:false }
      };
      const alertQueue = []; // FIFO: newest alert at front

      function fetchTelemetry(){
        const keys = Object.values(machines).flat();
        fetch(`${baseUrl}/api/plugins/telemetry/DEVICE/${deviceId}/values/timeseries?keys=${keys.join(",")}`, {
          headers:{ "X-Authorization":`Bearer ${jwt}` }
        })
        .then(res=>res.json())
        .then(data=>{
          Object.entries(machines).forEach(([m, keys])=>{
            let hasAlert=false, latestTs=0;
            keys.forEach(k=>{
              const p=data[k]?.[0];
              if(p){
                const v=parseFloat(p.value), el=document.getElementById(k);
                if(el){
                  el.innerText=v;
                  el.style.backgroundColor = v>90?"#f44336":v>50?"#ffeb3b":"";
                  el.style.color = v>90?"#fff":v>50?"#000":"";
                }
                if(p.ts>latestTs) latestTs=p.ts;
                if(v>90) hasAlert=true;
              }
            });

            // ALERT EVENT HANDLING
            if(hasAlert){
              if(!alertState[m].active){
                alertState[m].active=true;
                alertState[m].acknowledged=false;
                alertQueue.unshift(m);
              }
            }
            alertState[m].active = hasAlert;

            if(!hasAlert){
              const idx=alertQueue.indexOf(m);
              if(idx>=0) alertQueue.splice(idx,1);
              alertState[m].active=false;
              alertState[m].acknowledged=false;
            }
          });

          updateDisplay();
        })
        .catch(console.error);
      }

      function acknowledgeAlert(m){
        const idx=alertQueue.indexOf(m);
        if(idx>=0) alertQueue.splice(idx,1);
        alertState[m].acknowledged=true;
        alertState[m].active=false;
        updateDisplay();
      }

      function updateDisplay(){
        // Header
        const head=document.getElementById("header-row");
        const newHead=document.createElement("tr");
        newHead.id="header-row";
        newHead.appendChild(document.createElement("th")).innerText="Attribute";

        // Build column order: alerts first
        const order = [...alertQueue];
        ["M1","M2","M3"].forEach(m=>{ if(!order.includes(m)) order.push(m); });

        order.forEach(m=>{
          const th=document.createElement("th");
          th.id=`header-${m}`;
          th.innerText="Machine "+m[1];
          if(alertState[m].active && !alertState[m].acknowledged){
            const bell=document.createElement("span");
            bell.className="bell";
            bell.innerText="ðŸ””";
            bell.onclick=()=>acknowledgeAlert(m);
            th.appendChild(bell);
          }
          newHead.appendChild(th);
        });
        head.replaceWith(newHead);

        // Reorder rows
        document.querySelectorAll("tbody tr").forEach((r,i)=>{
          const tr=document.createElement("tr");
          tr.appendChild(r.children[0].cloneNode(true));
          order.forEach(m=>{
            const id=machines[m][i];
            const c=document.getElementById(id);
            tr.appendChild(c.cloneNode(true));
          });
          r.replaceWith(tr);
        });
      }

      fetchTelemetry();
      setInterval(fetchTelemetry,10000);
    };
  </script>
</body>
</html>
