<!DOCTYPE html>
<html>
<head>
  <title>Machine Telemetry Table</title>
  <style>
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ddd; padding:10px; text-align:center; cursor:pointer; }
    th { background:#f0f0f0; }
    .bell { color:red; cursor:pointer; margin-left:5px; }
    /* Modal styling */
    #trendModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    #trendContent { background:#fff; padding:20px; border-radius:4px; width:80%; max-width:600px; }
    #trendContent canvas { width:100%; height:300px; }
    #closeTrend { margin-top:10px; }
  </style>
</head>
<body>
  <h2>Machine Telemetry Table</h2>
  <table>
    <thead>
      <tr id="header-row">
        <th>Attribute</th>
        <th id="header-M1">Machine 1</th>
        <th id="header-M2">Machine 2</th>
        <th id="header-M3">Machine 3</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>A1</td><td id="M1_A1">--</td><td id="M2_A1">--</td><td id="M3_A1">--</td></tr>
      <tr><td>A2</td><td id="M1_A2">--</td><td id="M2_A2">--</td><td id="M3_A2">--</td></tr>
      <tr><td>A3</td><td id="M1_A3">--</td><td id="M2_A3">--</td><td id="M3_A3">--</td></tr>
    </tbody>
  </table>

  <!-- Modal for trend chart -->
  <div id="trendModal">
    <div id="trendContent">
      <h3 id="trendTitle"></h3>
      <canvas id="trendChart"></canvas>
      <button id="closeTrend">Close</button>
    </div>
  </div>

  <!-- Load Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    window.onload = function () {
      // existing token wait logic...
      // START OF initialize and create functions (omitted for brevity)
      // calls startApp(jwt) as before
    };

    // Inside startApp(jwt):
    function setupTrendPopup() {
      const modal = document.getElementById('trendModal');
      const content = document.getElementById('trendContent');
      const ctx = document.getElementById('trendChart').getContext('2d');
      const titleEl = document.getElementById('trendTitle');
      const closeBtn = document.getElementById('closeTrend');
      let chart;

      document.querySelectorAll('td[id]').forEach(td => {
        td.addEventListener('click', () => {
          const key = td.id; // e.g. "M1_A1"
          titleEl.innerText = `Trend for ${key}`;
          modal.style.display = 'flex';
          fetchTrendData(key).then(data => {
            const times = data.map(pt => new Date(pt.ts));
            const values = data.map(pt => pt.value);
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
              type: 'line',
              data: { labels: times, datasets: [{ label: key, data: values, borderColor: 'blue', fill: false }] },
              options: { scales: { x: { type: 'time', time: { unit: 'hour' } } } }
            });
          });
        });
      });

      closeBtn.onclick = modal.onclick = () => { modal.style.display = 'none'; };
    }

    async function fetchTrendData(key) {
      const now = Date.now();
      const start = new Date().setHours(0, 0, 0, 0);
      const resp = await fetch(`${baseUrl}/api/plugins/telemetry/DEVICE/${deviceId}/values/timeseries?keys=${key}&startTs=${start}&endTs=${now}&interval=60000`, {
        headers: { "X-Authorization": `Bearer ${jwt}` }
      });
      const data = await resp.json();
      return (data[key] || []).map(pt => ({ ts: pt.ts, value: parseFloat(pt.value) }));
    }

    // Call setupTrendPopup() at end of startApp()
  </script>
</body>
</html>
