<!DOCTYPE html>
<html>
<head>
  <title>Machine Telemetry Table</title>
  <style>
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ddd; padding:10px; text-align:center; }
    th { background:#f0f0f0; }
    .bell { color:red; cursor:pointer; margin-left:5px; }
  </style>
</head>
<body>
  <h2>Machine Telemetry Table</h2>
  <table>
    <thead>
      <tr id="header-row">
        <th>Attribute</th>
        <th id="header-M1">Machine 1</th>
        <th id="header-M2">Machine 2</th>
        <th id="header-M3">Machine 3</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>A1</td><td id="M1_A1">--</td><td id="M2_A1">--</td><td id="M3_A1">--</td></tr>
      <tr><td>A2</td><td id="M1_A2">--</td><td id="M2_A2">--</td><td id="M3_A2">--</td></tr>
      <tr><td>A3</td><td id="M1_A3">--</td><td id="M2_A3">--</td><td id="M3_A3">--</td></tr>
    </tbody>
  </table>

  <script>
    window.onload = function () {
      function waitForTokenAndStart() {
        const params = new URLSearchParams(window.location.search);
        const jwt = params.get("token");
        if (!jwt) {
          setTimeout(waitForTokenAndStart, 100);
          return;
        }
        startApp(jwt);
      }

      waitForTokenAndStart();

      function startApp(jwt) {
        const deviceId = "1e101ee0-5bd5-11f0-9d02-c191323b4da2";
        const baseUrl = "https://thingsboard.cloud";

        const machines = {
          "M1": ["M1_A1", "M1_A2", "M1_A3"],
          "M2": ["M2_A1", "M2_A2", "M2_A3"],
          "M3": ["M3_A1", "M3_A2", "M3_A3"]
        };

        const alarms = {
          "M1": "M1_Alarm",
          "M2": "M2_Alarm",
          "M3": "M3_Alarm"
        };

        const bellAcknowledged = {
          "M1": false,
          "M2": false,
          "M3": false
        };

        function fetchTelemetry() {
          const keys = [...Object.values(machines).flat(), ...Object.values(alarms)];
          const url = `${baseUrl}/api/plugins/telemetry/DEVICE/${deviceId}/values/timeseries?keys=${keys.join(",")}`;

          fetch(url, {
            headers: { "X-Authorization": `Bearer ${jwt}` }
          })
          .then(res => res.json())
          .then(data => {
            const alarmEntries = [];
            const inactive = [];

            ["M1", "M2", "M3"].forEach(machine => {
              const alarmKey = alarms[machine];
              const alarmData = data[alarmKey]?.[0];
              const alarmVal = parseInt(alarmData?.value || 0);
              const ts = alarmData?.ts || 0;

              if (alarmVal === 1) {
                alarmEntries.push({ machine, ts });
              } else {
                bellAcknowledged[machine] = false;
                inactive.push(machine);
              }

              machines[machine].forEach(key => {
                const point = data[key]?.[0];
                if (point) {
                  const el = document.getElementById(key);
                  if (el) el.innerText = parseFloat(point.value);
                }
              });
            });

            // Sort alarms by newest timestamp
            alarmEntries.sort((a, b) => b.ts - a.ts);
            const activeOrdered = alarmEntries.map(entry => entry.machine);
            const finalOrder = [...activeOrdered, ...inactive];

            const alarmValues = Object.fromEntries(alarmEntries.map(a => [a.machine, 1]));
            reorderColumns(finalOrder, alarmValues);
          })
          .catch(err => console.error("Fetch error:", err));
        }

        function acknowledgeAlert(machine) {
          bellAcknowledged[machine] = true;
          fetchTelemetry();
        }

        function reorderColumns(order, alarmValues) {
          const headerRow = document.getElementById("header-row");
          const newHeader = document.createElement("tr");
          newHeader.id = "header-row";
          const labelTh = document.createElement("th");
          labelTh.innerText = "Attribute";
          newHeader.appendChild(labelTh);

          order.forEach(machine => {
            const th = document.createElement("th");
            th.id = `header-${machine}`;
            th.innerText = `Machine ${machine[1]}`;

            if (alarmValues[machine] === 1 && !bellAcknowledged[machine]) {
              const bell = document.createElement("span");
              bell.className = "bell";
              bell.innerText = "ðŸ””";
              bell.title = "Click to acknowledge";
              bell.addEventListener("click", () => acknowledgeAlert(machine));
              th.appendChild(bell);
            }

            newHeader.appendChild(th);
          });

          headerRow.replaceWith(newHeader);

          const rows = document.querySelectorAll("tbody tr");
          rows.forEach((row, i) => {
            const newRow = document.createElement("tr");
            newRow.appendChild(row.children[0].cloneNode(true));
            order.forEach(machine => {
              const key = machines[machine][i];
              const cell = document.getElementById(key);
              const newCell = document.createElement("td");
              newCell.id = key;
              newCell.innerText = cell ? cell.innerText : "--";
              newRow.appendChild(newCell);
            });
            row.replaceWith(newRow);
          });
        }

        fetchTelemetry();
        setInterval(fetchTelemetry, 10000);
      }
    };
  </script>
</body>
</html>
